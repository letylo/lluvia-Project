<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>The source code</title>
  <link href="../resources/prettify/prettify.css" type="text/css" rel="stylesheet" />
  <script type="text/javascript" src="../resources/prettify/prettify.js"></script>
  <style type="text/css">
    .highlight { display: block; background-color: #ddd; }
  </style>
  <script type="text/javascript">
    function highlight() {
      document.getElementById(location.hash.replace(/#/, "")).className = "highlight";
    }
  </script>
</head>
<body onload="prettyPrint(); highlight();">
  <pre class="prettyprint lang-js"><span id='Engine-Automata'>/**
</span> * @class Engine.Automata
 *
 * Creates a state machine. A lluvia state machine has a continous and derivable state,
 * made of the previous, the current and the requested one. During state transition, several solicitor functions
 * get executed: down function of the current state, up solicitor of the requested state and finally we arrive to the
 * steady state.
 */

<span id='Engine-Automata-method-constructor'>/**
</span> * @method constructor
 *
 * ## Example
 *
 *     var state = new Enumeration(&quot;initial&quot;, &quot;running&quot;, &quot;sleeping&quot;)
 *     var a = new Automata( states,
 *                          {previous:  state.initial,
 *                           current:   state.initial,
 *                           requested: state.running })
 *
 *
 * or, for nested states:
 *
 *     var a = new Automata([&quot;killing&quot;, [&quot;running&quot;, [&quot;phase1&quot;, &quot;phase2&quot;], &quot;supended&quot; ]])
 *
 *
 * @param  {Object | Array}   states Possibles states of an automata (Enumeration).
 *                                   Array is an extesnsion for Hierarchical State Machines.
 * @param  {Object}   initialState	 Initial state of the automata.
 * @param  {Array}    solicitor		 State Manager functions. An array with three functions (up, steady, down).
 * @return {Automata}				 New created state machine automata..
 * @constructor
 */
Automata.prototype.constructor = Automata;

function Automata(states, solicitor, initial_state) {

    if (states instanceof Array)
        states = new(ProxyConstructor(EnumerationOf, State, states))
    this.state = states ? states : new Enumeration()
    this.state.each(function(state, value) {
        alert(state + &quot;: &quot; + value)
    })

    // Always none equals -1
    this.state.none = State.NONE

    // todo: Make a proxyConstructor that handles the link via the this parameter.
    this.current = new StateGear(this, initial_state)

    this.solicitor = (solicitor || solicitor != null) ?
        solicitor :
        new Array(new Array(null, null, null));

    // State none doesn&#39;t execute anything, neither raises an error.

    this.solicitor[this.state.none] = [

        function() {},
        function() {},
        function() {}
    ]
}

<span id='Engine-Automata-property-state'>/**
</span> * @property {Enumeration} state Group of constants representing the
 *                               numbers for every possible state.
 *
 * ### Example
 *
 *     this.state = new Enumeration(&quot;killing&quot;, &quot;running&quot;, [&quot;phase1&quot;, &quot;phase2&quot;], &quot;supended&quot;)
 *     //=&gt; {
 *     //=&gt;    killing: 	{0:{}},
 *     //=&gt;    running: 	{1:{}, phase1:{1:{1:{}}}, phase2:{1:{2:{}}}},
 *     //=&gt;    supended: 	{2:{}})
 *     //=&gt; }
 *
 * Every value, despite it is actually an object, it behaves as a number.
 *
 *     this.state.running.phase2 == 2
 *     //=&gt; true
 *
 * And keeps track of its path.
 *
 *     this.state.running.phase2.toString()
 *     //=&gt; &quot;1.2&quot;
 *
 * Entrusted with the gifts of Enumeration we cand do:
 *
 *     this.state.keys()
 *     //=&gt; [&quot;killing&quot;, &quot;running&quot;, &quot;supended&quot;]
 *
 * and
 *
 *     this.state.running.branches()
 *     //=&gt; [&quot;phase1&quot;, &quot;phase2&quot;]
 *
 *
 * And because of the special VersionNumber method toString and the mathematical ring
 * composed by VersionNumber, InterleavedArray and Enumerate we can state:
 *
 *     // InterleavedArray mate.
 *     var i = new InterleavedArray(&quot;a&quot;, &quot;b&quot;, [&quot;b1&quot;, &quot;b2&quot;], &quot;c&quot;)
 *     i[this.state.running.phase1]
 *     //=&gt; &quot;b1&quot;
 *
 */


<span id='Engine-Automata-method-run'>/**
</span> * @method	  run
 * Behavior of the automata according to its internal state.
 * This function takes care of state transitions.
 *
 */
Automata.prototype.run = function() {
    return this.solicitor[this.current][0]()
        /*
    Automata.prototype.drive_state.apply(this, arguments)
    if (this.currentState.requested != this.state.none) {
        this.currentState.previous = this.currentState.current;
        this.currentState.current = this.currentState.requested;
        this.currentState.requested = this.state.none;
    }
    */
}</pre>
</body>
</html>
