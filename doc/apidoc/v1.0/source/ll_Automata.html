<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>The source code</title>
  <link href="../resources/prettify/prettify.css" type="text/css" rel="stylesheet" />
  <script type="text/javascript" src="../resources/prettify/prettify.js"></script>
  <style type="text/css">
    .highlight { display: block; background-color: #ddd; }
  </style>
  <script type="text/javascript">
    function highlight() {
      document.getElementById(location.hash.replace(/#/, "")).className = "highlight";
    }
  </script>
</head>
<body onload="prettyPrint(); highlight();">
  <pre class="prettyprint lang-js"><span id='Engine-Automata'>/**
</span> * @class Engine.Automata
 * 
 * Creates a state machine. A lluvia state machine has a continous and derivable state,
 * made of the previous, the current and the requested one. During state transition, several solicitor functions
 * get executed: down function of the current state, up solicitor of the requested state and finally we arrive to the
 * steady state.
 */

<span id='Engine-Automata-method-constructor'>/**
</span> * @method constructor 
 *
 * ## Example 
 *
 *     var state = new Enumeration(&quot;initial&quot;, &quot;running&quot;, &quot;sleeping&quot;)
 *     var a = new Automata( states, 
 *                          {previous:  state.initial,
 *                           current:   state.initial,
 *                           requested: state.running })
 *
 *
 * or, for nested states:
 *
 *     var a = new Automata([&quot;killing&quot;, [&quot;running&quot;, [&quot;phase1&quot;, &quot;phase2&quot;], &quot;supended&quot; ]])
 *
 * 
 * @param  {Object | Array}   states Possibles states of an automata (Enumeration).
 *                                   Array is an extesnsion for Hierarchical State Machines.
 * @param  {Object}   initialState	 Initial state of the automata.
 * @param  {Array}    solicitor		 State Manager functions. An array with three functions (up, steady, down).
 * @return {Automata}				 New created state machine automata..
 * @constructor
 */
Automata.prototype.constructor = Automata;
function Automata(states, initialState, solicitor){

	if (states)

	this.state = states == null ? { none: -1 } : states;
	this.state_name = []
	for (var key in this.state)
		if (this.state.hasOwnProperty(key))
			this.state_name[this.state[key]] = key

	this.stateChange  = {	up: 0, steady:1, down: 2};
	this.currentState = initialState != null ? initialState:
						{	previous  : this.state.none,
							current   : this.state.none,
							requested : this.state.none };
	this.solicitor = (solicitor || solicitor != null) ? solicitor : new Array(new Array(null, null, null));
}


<span id='Engine-Automata-method-drive_state'>/**
</span> * @method drive_state
 * Executes the solicitor functions related to the fsm state.
 * All arguments are passed to solicitors.
 *
 */
Automata.prototype.drive_state = function() {

	var base   = this.state_name[this.currentState.current]
	var down   = base + &quot;_down&quot;
	var steady = base + &quot;_steady&quot;
	var up     = base + &quot;_up&quot;

	if ( this.currentState.requested != this.state.none ){
		this.solicitor[this.currentState.current][this.stateChange.down].apply(this, arguments)
		if ( this[down])
			this[down]()

		this.solicitor[this.currentState.requested][this.stateChange.up].apply(this, arguments)
		if (this[up])
			this[up]()

	}

	this.solicitor[this.currentState.current][this.stateChange.steady].apply(this, arguments)
	if (this[steady])
		this[steady]()

}

<span id='Engine-Automata-method-run'>/**
</span> * @method	  run
 * Behavior of the automata according to its internal state.
 * This function takes care of state transitions.
 *
 */
Automata.prototype.run = function(){

	Automata.prototype.drive_state.apply(this, arguments)
	if ( this.currentState.requested != this.state.none ){
		this.currentState.previous  = this.currentState.current;
		this.currentState.current   = this.currentState.requested;
		this.currentState.requested = this.state.none;
	}
}
</pre>
</body>
</html>
